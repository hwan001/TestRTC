# ğŸ”§ Build Stage
FROM maven:3.9-eclipse-temurin-17 AS build
WORKDIR /src

COPY pom.xml .
RUN mvn -q -B -DskipTests dependency:go-offline

COPY src ./src
# repackageê¹Œì§€ ë³´ì¥ (í”ŒëŸ¬ê·¸ì¸ ì„¤ì •ì— ë”°ë¼ packageë§Œìœ¼ë¡œë„ ìƒì„±ë  ìˆ˜ ìˆìœ¼ë‚˜ ì•ˆì „í•˜ê²Œ)
RUN mvn -q -B -DskipTests package spring-boot:repackage

# layertools ë™ì‘ í™•ì¸ ë° ë ˆì´ì–´ ì¶”ì¶œ
RUN set -eux; \
    JAR="$(ls target/*.jar | head -n1)"; \
    echo "Using JAR=$JAR"; \
    java -Djarmode=layertools -jar "$JAR" list; \
    mkdir -p /layers; \
    java -Djarmode=layertools -jar "$JAR" extract --destination /layers; \
    echo "Extracted layers:"; \
    find /layers -maxdepth 2 -type d -print

# ğŸƒ Runtime Stage
FROM eclipse-temurin:17-jre
WORKDIR /app

# ë ˆì´ì–´ ë³„ë„ COPY (ì—¬ê¸°ì„œ ê²½ë¡œê°€ ë°˜ë“œì‹œ ì¡´ì¬í•´ì•¼ í•¨)
COPY --from=build /layers/dependencies/          /app/
COPY --from=build /layers/snapshot-dependencies/ /app/
COPY --from=build /layers/spring-boot-loader/    /app/
COPY --from=build /layers/application/           /app/

EXPOSE 8080
ENTRYPOINT ["java","org.springframework.boot.loader.JarLauncher"]
